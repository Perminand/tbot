# Система управления рисками - Документация

## Обзор

Реализована улучшенная система управления рисками, которая разделяет "правила" и "текущее состояние" позиций. Система хранит не только процентные правила, но и рассчитанные ценовые уровни, watermark'и и полную историю изменений.

## Архитектура

### Основные компоненты

1. **PositionRiskState** - состояние рисков по позиции
2. **RiskEvent** - аудиторские события по рискам
3. **PositionRiskStateService** - сервис управления состоянием рисков
4. **RiskController** - REST API для фронтенда
5. **PositionWatcherService** - обновленный сервис мониторинга позиций

### База данных

#### Таблица `position_risk_state`
- `account_id`, `figi`, `side` - идентификация позиции
- `sl_pct`, `tp_pct`, `trailing_pct` - процентные правила
- `sl_level`, `tp_level` - рассчитанные ценовые уровни
- `high_watermark`, `low_watermark` - экстремумы для trailing
- `entry_price`, `avg_price_snapshot`, `qty_snapshot` - снимки позиции
- `trailing_type`, `min_step_ticks` - настройки трейлинга
- `updated_at`, `source` - метаданные

#### Таблица `risk_events`
- Аудит всех изменений в системе рисков
- Типы событий: SL_UPDATED, TP_UPDATED, TRAILING_UPDATED, WATERMARK_UPDATED, POSITION_CLOSED
- Детальная информация о каждом изменении

## Функциональность

### 1. Автоматическое создание состояния рисков
- При каждом проходе `PositionWatcherService` создает или обновляет состояние рисков
- Автоматически рассчитывает уровни SL/TP на основе процентных правил
- Поддерживает watermark'ы для trailing stop

### 2. Trailing Stop
- **Для лонгов**: SL подтягивается вверх при росте цены
- **Для шортов**: SL подтягивается вниз при падении цены
- Использует `high_watermark`/`low_watermark` для отслеживания экстремумов
- Обновляется только в направлении улучшения (монотонность)

### 3. Аудит и логирование
- Каждое изменение watermark'а логируется
- Каждое обновление SL/TP фиксируется
- Полная история изменений доступна через API

### 4. Восстановление состояния
- При перезапуске бота состояние рисков восстанавливается из БД
- Не теряются настройки trailing stop
- Сохраняется история watermark'ов

## API Endpoints

### Управление состоянием рисков
- `GET /api/risk/states/{accountId}` - все состояния рисков аккаунта
- `GET /api/risk/states/{accountId}/{figi}` - состояние по конкретному инструменту
- `GET /api/risk/active-stops` - позиции с активными SL
- `GET /api/risk/active-takes` - позиции с активными TP

### История событий
- `GET /api/risk/events/{accountId}` - события по аккаунту
- Поддержка фильтрации по типу события и лимиту
- Поиск по FIGI/названию инструмента

## Frontend

### Страница `risk-management.html`
- **Обзор**: статистика по активным SL/TP/trailing позициям
- **Позиции**: детальный список всех позиций с рисками
- **События**: история изменений с фильтрацией
- **Настройки**: конфигурация системы рисков

### Возможности
- Реальное время обновления данных
- Фильтрация и поиск
- Визуальные индикаторы статуса
- Детальная информация по каждой позиции

## Преимущества новой системы

### 1. Надежность
- Состояние сохраняется в БД, не теряется при перезапуске
- Атомарные обновления watermark'ов
- Аудит всех изменений

### 2. Производительность
- Не пересчитываем SL/TP на каждом тике
- Используем готовые уровни из БД
- Индексы для быстрого поиска

### 3. Наблюдаемость
- Полная история изменений
- Детальные логи с причинами
- UI для мониторинга состояния

### 4. Гибкость
- Поддержка разных типов trailing (процентный, ATR, фиксированный)
- Настраиваемые пороги обновления
- Расширяемая архитектура

## Миграция

### Шаги для внедрения
1. Выполнить SQL скрипт `risk-tables.sql`
2. Перезапустить приложение
3. Новая система автоматически создаст состояния для существующих позиций
4. Старая логика trailing stop в `PositionWatcherService` заменена на новую

### Обратная совместимость
- Старые правила рисков (`risk_rules`) продолжают работать
- Новые поля добавляются к существующим позициям
- Постепенная миграция без прерывания работы

## Мониторинг и отладка

### Ключевые метрики
- Количество активных SL/TP
- Частота обновления watermark'ов
- Время отклика системы рисков

### Логи для отладки
- `PositionRiskStateService`: создание/обновление состояний
- `PositionWatcherService`: срабатывание SL/TP
- `RiskEvent`: детальная история изменений

### Типичные проблемы
1. **SL не обновляется**: проверить `trailing_pct` и watermark'ы
2. **Позиция не закрывается**: проверить `sl_level` и текущую цену
3. **Trailing не работает**: проверить настройки и логи watermark'ов

## Дальнейшее развитие

### Планируемые улучшения
1. **ATR-based trailing**: использование Average True Range для динамического trailing
2. **Channel-based trailing**: trailing по техническим каналам
3. **Risk alerts**: уведомления о критических изменениях
4. **Backtesting**: тестирование стратегий на исторических данных
5. **Machine Learning**: автоматическая оптимизация параметров

### Интеграция
- WebSocket для real-time обновлений
- Push-уведомления
- Экспорт данных для внешнего анализа
- API для внешних систем управления рисками

## Заключение

Новая система управления рисками обеспечивает:
- **Надежность**: сохранение состояния в БД
- **Производительность**: оптимизированные алгоритмы
- **Наблюдаемость**: полный аудит изменений
- **Масштабируемость**: модульная архитектура

Система готова к продакшену и может быть расширена дополнительными функциями по мере необходимости.
