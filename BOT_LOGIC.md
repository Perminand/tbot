# Полная логика работы торгового бота

## 1. ИНИЦИАЛИЗАЦИЯ И ЗАПУСК

### 1.1. Старт приложения
- **Точка входа**: `Main.java` → `SpringApplication.run()`
- **Режим работы**: Определяется через `TradingModeService` (production/sandbox)
- **API подключение**: `InvestApiManager` инициализирует подключение к Tinkoff Invest API

### 1.2. Инициализация при старте (`StartupInitializer`)
- Установка дефолтных настроек риска:
  - `risk_default_sl_pct`: 2% (стоп-лосс)
  - `risk_default_tp_pct`: 6% (тейк-профит)
  - `risk_default_trailing_pct`: 3% (трейлинг)
  - `risk_per_trade_pct`: 0.5% (риск на сделку)
- Проверка и включение автоматического мониторинга (если `auto_monitor.enable = true`)
- Выбор аккаунта для автоматического мониторинга

---

## 2. ПЛАНИРОВЩИКИ И ПЕРИОДИЧЕСКИЕ ЗАДАЧИ

### 2.1. Умный быстрый мониторинг (каждые 5 минут)
**Сервис**: `TradingBotScheduler.smartQuickMonitoring()`

**Последовательность действий**:
1. Проверка синхронизации режимов торговли (`TradingModeProtectionService`)
2. Установка флага активной торговли
3. Для каждого аккаунта:
   - **Приоритет**: Проверка и закрытие шорт-позиций (`checkAndCloseShortPositions`)
   - Получение списка инструментов для быстрого анализа (`SmartAnalysisService.getInstrumentsForQuickAnalysis`)
   - Для каждого инструмента:
     - Анализ тренда на 15-минутных свечах
     - Обновление приоритета инструмента
     - Выполнение торговой стратегии (`executeTradingStrategy`)
4. Снятие флага активной торговли

### 2.2. Умный полный мониторинг (каждые 15 минут)
**Сервис**: `TradingBotScheduler.smartFullMonitoring()`

**Отличия от быстрого**:
- Анализ тренда на часовых свечах (более долгосрочный)
- Больше инструментов для анализа
- Более глубокий анализ

### 2.3. Мониторинг жестких OCO ордеров (каждые 30 секунд)
**Сервис**: `HardOcoMonitorService.monitorHardOcoOrders()`

**Задачи**:
- Проверка статуса жестких OCO ордеров у брокера
- Отмена парного ордера при срабатывании одного из пары
- Обновление статусов в базе данных

### 2.4. Проверка и установка жестких стоп-ордеров (каждые 5 минут)
**Сервис**: `HardOcoMonitorService.checkAndSetupHardStopsForPositions()`

**Логика**:
- Проверка, включена ли функция жестких стоп-ордеров (`hard_stops.enabled`)
- Проверка режима (только production)
- Для каждой позиции:
  - Проверка наличия активных жестких OCO ордеров
  - Если отсутствуют → установка новых жестких стоп-ордеров
  - Если цены слишком далеко от текущей рыночной (>10%) → используются виртуальные OCO

### 2.5. Мониторинг виртуальных стоп-ордеров (каждые 30 секунд)
**Сервис**: `VirtualStopMonitorService.monitorVirtualStops()`

**Задачи**:
- Проверка виртуальных стоп-лоссов и тейк-профитов
- Исполнение при достижении ценовых уровней
- Отмена парных ордеров в OCO группах

### 2.6. Мониторинг позиций (каждые 15 секунд)
**Сервис**: `PositionWatcherService.watchPositions()`

**Задачи**:
- Отслеживание текущих позиций
- Проверка условий для трейлинг-стопов
- Обновление состояний рисков

### 2.7. Синхронизация портфеля (каждые 5 минут)
**Сервис**: `PortfolioManagementService.syncPortfolio()`

**Задачи**:
- Обновление данных о позициях
- Синхронизация с данными брокера
- Обновление балансов

### 2.8. Проверка ребалансировки (каждую минуту)
**Сервис**: `PortfolioManagementService.checkRebalancing()`

**Задачи**:
- Анализ текущего распределения активов
- Проверка отклонений от целевых пропорций
- Принятие решений о ребалансировке

---

## 3. АНАЛИЗ РЫНКА И ПРИНЯТИЕ РЕШЕНИЙ

### 3.1. Получение инструментов для анализа
**Сервис**: `SmartAnalysisService`

**Логика выбора инструментов**:
- **Приоритетные**: Существующие позиции в портфеле
- **Ротируемые**: Инструменты из кэша `DynamicInstrumentService`
- **Фильтрация**: Только доступные для торговли инструменты

### 3.2. Анализ тренда
**Сервис**: `MarketAnalysisService.analyzeTrend()`

**Параметры анализа**:
- **SMA20, SMA50**: Скользящие средние (20 и 50 периодов)
- **RSI**: Индекс относительной силы (14 периодов)
- **Текущая цена**: Через OrderBook или последнюю свечу
- **Интервал свечей**: 15 минут (быстрый) или 1 час (полный)

**Определение тренда**:
- **BULLISH**: SMA20 > SMA50, цена выше SMA20, RSI > 50
- **BEARISH**: SMA20 < SMA50, цена ниже SMA20, RSI < 50
- **SIDEWAYS**: Неопределенный тренд

### 3.3. Выполнение торговой стратегии
**Сервис**: `PortfolioManagementService.executeTradingStrategy()`

**Последовательность принятия решений**:

#### Шаг 1: Получение базового сигнала
- Анализ тренда и RSI
- Определение базового действия: BUY / SELL / HOLD / CLOSE_SHORT

#### Шаг 2: Продвинутый анализ (если включен)
- Анализ через `AdvancedTradingStrategyService`
- Учет дополнительных факторов (объемы, волатильность)
- Генерация продвинутого сигнала

#### Шаг 3: Сведение сигналов
- Объединение базового и продвинутого сигналов
- Приоритет продвинутого сигнала при достаточной силе (>50)

#### Шаг 4: Проверки перед торговлей

**4.1. Проверка ликвидности**:
- Спрэд не превышает лимит (зависит от уровня ликвидности)
- Объем торгов достаточен
- Уровни ликвидности: SMALL / MEDIUM / LARGE

**4.2. Проверка cooldown (защита от переторговли)**:
- Временные окна между сделками по одному инструменту
- Разные окна для BUY и SELL
- Блокировка при частых сделках

**4.3. Проверка средств**:
- Доступные средства (cash)
- Покупательная способность (buying power, включая маржу)
- Проверка маржинальной торговли (если включена)

**4.4. Проверка размера позиции**:
- Расчет через `CapitalManagementService`
- Учет риска на сделку (0.5% от портфеля)
- Ограничения по максимальной доле инструмента
- Адаптивная диверсификация

**4.5. Проверка прибыльности**:
- Расчет break-even с учетом комиссий и спрэда
- Проверка соотношения риск/прибыль (RR >= 1.5)
- Учет минимального отступа (edge buffer)

**4.6. Проверка волатильности (ATR)**:
- ATR должен быть в диапазоне 0.2% - 8%
- Слишком низкая волатильность → блокировка
- Слишком высокая волатильность → блокировка

#### Шаг 5: Исполнение решения

**5.1. CLOSE_SHORT (закрытие шорта)**:
- Приоритетное действие
- Немедленное размещение ордера BUY
- Без дополнительных проверок средств

**5.2. BUY (покупка)**:
- Проверка наличия шорт-позиции → приоритетное закрытие
- Расчет количества лотов через `CapitalManagementService`
- Размещение ордера через `OrderService.placeOptimalOrder()`
- Установка стоп-лосса и тейк-профита:
  - Если `hard_stops.enabled = true` и режим = production:
    - Проверка расстояния цен от текущей рыночной
    - Если >10% → виртуальные OCO
    - Если ≤10% → жесткие OCO (реальные ордера у брокера)
  - Иначе → виртуальные OCO

**5.3. SELL (продажа)**:
- Проверка наличия LONG позиции
- Расчет количества лотов для продажи
- Размещение ордера на продажу
- Установка стоп-ордеров (если применимо)

**5.4. HOLD (удержание)**:
- Нет действий
- Продолжение мониторинга

---

## 4. РАЗМЕЩЕНИЕ ОРДЕРОВ

### 4.1. Типы ордеров

**4.1.1. Рыночный ордер** (`placeMarketOrder`):
- Немедленное исполнение по текущей рыночной цене
- Используется для срочных операций (закрытие шорта)

**4.1.2. Лимитный ордер** (`placeLimitOrder`):
- Исполнение по указанной цене или лучше
- Используется для take-profit в HARD OCO
- Проверка расстояния от текущей рыночной цены

**4.1.3. Стоп-ордер** (`placeStopOrder`):
- Активация при достижении стоп-цены
- Используется для stop-loss в HARD OCO

**4.1.4. Умный лимитный ордер** (`placeSmartLimitOrder`):
- Автоматический расчет оптимальной цены на основе bid/ask
- Небольшой отступ для гарантированного исполнения
- Используется для обычных покупок/продаж

**4.1.5. Оптимальный ордер** (`placeOptimalOrder`):
- Выбор между рыночным и лимитным ордером
- Учет спрэда и ликвидности
- Fallback на рыночный ордер при ошибках

### 4.2. OCO ордера (One-Cancels-Other)

**4.2.1. Жесткие OCO (HARD OCO)**:
- Реальные ордера у брокера
- Только в production режиме
- Требование: цены не должны быть слишком далеко от текущей рыночной (≤10%)
- Состоят из:
  - Take-Profit: лимитный ордер SELL (для LONG)
  - Stop-Loss: стоп-ордер SELL (для LONG)

**4.2.2. Виртуальные OCO**:
- Мониторинг через `VirtualStopMonitorService`
- Работают в любом режиме
- Исполняются через размещение рыночных/лимитных ордеров при достижении уровней
- Автоматическая отмена парного ордера при срабатывании одного

### 4.3. Проверки перед размещением ордера

**4.3.1. Коррекция лотов** (`clampLotsByHoldings`):
- Для SELL: не продавать больше, чем есть в LONG
- Для BUY: не покупать больше, чем нужно для закрытия SHORT

**4.3.2. Проверка Panic-Stop**:
- Глобальная блокировка торговли
- Проверка через `BotControlService.isPanic()`

**4.3.3. Лимит ордеров**:
- Ограничение количества ордеров в минуту (50 по умолчанию)
- Контроль через `ApiRateLimiter`

---

## 5. УПРАВЛЕНИЕ РИСКАМИ

### 5.1. Стоп-лосс и тейк-профит

**5.1.1. Правила риска**:
- Индивидуальные правила для каждого инструмента (`RiskRuleService`)
- Дефолтные значения: SL=2%, TP=6%
- Настраиваемые через базу данных

**5.1.2. Трейлинг-стоп**:
- Автоматическое перемещение стоп-лосса при росте прибыли
- Настраиваемый процент трейлинга (3% по умолчанию)
- Работает для виртуальных и жестких ордеров

### 5.2. Управление капиталом

**5.2.1. Размер позиции**:
- Расчет через `CapitalManagementService`
- Учет риска на сделку (0.5% от портфеля)
- Ограничение максимальной доли инструмента
- Адаптивная диверсификация по классам активов

**5.2.2. Маржинальная торговля**:
- Проверка доступности маржи
- Расчет покупательной способности
- Ограничения по использованию маржи
- Настройка через `margin-trading.*` параметры

### 5.3. Защита от переторговли

**5.3.1. Cooldown**:
- Временные окна между сделками
- Разные окна для BUY и SELL
- Блокировка при частых сделках по одному инструменту

**5.3.2. Блокировка по ликвидности**:
- Временная блокировка инструментов с плохой ликвидностью
- Автоматическое снятие блокировки
- Логирование причин блокировки

### 5.4. Мониторинг позиций

**5.4.1. Отслеживание состояний рисков**:
- Сохранение состояний в `PositionRiskStateService`
- Отслеживание high/low watermark
- Обновление уровней SL/TP при трейлинге

**5.4.2. События рисков**:
- Логирование всех событий в `risk_events`
- Отслеживание изменений уровней
- История изменений

---

## 6. МОНИТОРИНГ И ЛОГИРОВАНИЕ

### 6.1. Система логирования

**6.1.1. BotLogService**:
- Централизованное логирование
- Категории: MARKET_ANALYSIS, PORTFOLIO_MANAGEMENT, TRADING_STRATEGY, RISK_MANAGEMENT, AUTOMATIC_TRADING, SYSTEM_STATUS
- Уровни: INFO, WARNING, ERROR, SUCCESS, TRADE

**6.1.2. SSE (Server-Sent Events)**:
- Реальное время логи на странице `test-sse.html`
- Автоматическая отправка через `LogStreamController`
- Подписка через `/api/logs/stream`

### 6.2. Отслеживание балансов

**6.2.1. BalanceTrackerService**:
- Периодическое сохранение снимков баланса
- Отслеживание изменений портфеля
- История балансов в `account_balance_snapshots`

### 6.3. Аналитика

**6.3.1. AnalyticsService**:
- Сбор статистики по сделкам
- Анализ производительности
- Отчеты по прибыльности

---

## 7. ЗАЩИТА И БЕЗОПАСНОСТЬ

### 7.1. Защита режима торговли

**7.1.1. TradingModeProtectionService**:
- Проверка синхронизации режимов (TradingModeService, InvestApiManager, БД)
- Блокировка изменений режима при активной торговле
- Валидация перед каждой операцией

### 7.2. Panic-Stop

**7.2.1. BotControlService**:
- Глобальная блокировка торговли
- Немедленная остановка всех операций
- Ручное управление через API

### 7.3. Ограничение частоты запросов

**7.3.1. ApiRateLimiter**:
- Ограничение 50 запросов в минуту
- Автоматическая задержка при превышении
- Распределение запросов во времени

---

## 8. РЕБАЛАНСИРОВКА ПОРТФЕЛЯ

### 8.1. Анализ портфеля

**8.1.1. PortfolioAnalysis**:
- Расчет текущего распределения активов
- Сравнение с целевыми пропорциями
- Выявление отклонений

### 8.1.2. Решение о ребалансировке:
- Проверка отклонений от целевых пропорций
- Расчет необходимых изменений
- Принятие решения о ребалансировке

### 8.2. Выполнение ребалансировки

**8.2.1. Логика**:
- Продажа избыточных активов
- Покупка недостающих активов
- Учет комиссий и спрэдов
- Минимизация количества сделок

---

## 9. ОБРАБОТКА ОШИБОК И ИСКЛЮЧЕНИЙ

### 9.1. Уровни обработки

**9.1.1. На уровне сервисов**:
- Try-catch блоки в критических местах
- Логирование ошибок
- Продолжение работы при некритических ошибках

**9.1.2. На уровне планировщиков**:
- Обработка ошибок для каждого инструмента отдельно
- Не прерывание работы при ошибке одного инструмента
- Логирование всех ошибок

### 9.2. Восстановление после ошибок

**9.2.1. Автоматическое восстановление**:
- Повторные попытки при временных ошибках API
- Fallback на альтернативные методы
- Сохранение состояния при ошибках

---

## 10. КОНФИГУРАЦИЯ И НАСТРОЙКИ

### 10.1. TradingSettingsService

**10.1.1. Хранение настроек**:
- База данных (`trading_settings`)
- Ключ-значение структура
- Описания для каждого параметра

**10.1.2. Основные настройки**:
- `hard_stops.enabled`: Включение жестких стоп-ордеров
- `hard_stops.trailing.enabled`: Включение трейлинга
- `auto_monitor.enable`: Автоматический мониторинг
- `margin-trading.*`: Настройки маржинальной торговли
- `risk.*`: Настройки управления рисками
- `trading.*`: Настройки торговли
- `liquidity.*`: Настройки ликвидности

### 10.2. Режимы работы

**10.2.1. Production**:
- Реальные сделки
- Реальные ордера у брокера
- Жесткие OCO ордера (если включены)

**10.2.2. Sandbox**:
- Тестовые сделки
- Виртуальные ордера
- Без реальных денег

---

## 11. ПОЛНЫЙ ЦИКЛ РАБОТЫ БОТА

### Пример полного цикла для одного инструмента:

1. **Планировщик запускает мониторинг** (каждые 5 минут)
2. **Получение инструментов** → Список инструментов для анализа
3. **Анализ тренда** → Определение BULLISH/BEARISH/SIDEWAYS
4. **Генерация сигнала** → BUY/SELL/HOLD
5. **Проверки**:
   - Ликвидность ✓
   - Cooldown ✓
   - Средства ✓
   - Размер позиции ✓
   - Прибыльность ✓
   - Волатильность ✓
6. **Исполнение**:
   - Размещение ордера
   - Установка SL/TP (жесткие или виртуальные)
7. **Мониторинг**:
   - Отслеживание позиции
   - Обновление трейлинг-стопов
   - Проверка OCO ордеров
8. **Закрытие позиции**:
   - При достижении TP или SL
   - Отмена парного ордера
   - Логирование результата

---

## 12. ВАЖНЫЕ ОСОБЕННОСТИ

### 12.1. Приоритеты операций

1. **Высший приоритет**: Закрытие шорт-позиций
2. **Высокий приоритет**: Защита от убытков (стоп-лоссы)
3. **Средний приоритет**: Реализация прибыли (тейк-профиты)
4. **Низкий приоритет**: Открытие новых позиций

### 12.2. Адаптивность

- Адаптивная диверсификация
- Адаптивные лимиты позиций
- Адаптивные настройки ликвидности
- Умный выбор инструментов для анализа

### 12.3. Оптимизация

- Минимизация комиссий (умный выбор ордеров)
- Снижение количества запросов к API
- Кэширование данных
- Приоритизация инструментов

---

## ЗАКЛЮЧЕНИЕ

Бот работает в полностью автоматическом режиме, постоянно анализируя рынок, принимая решения на основе технического анализа и управляя рисками. Все операции логируются и отслеживаются в реальном времени через систему SSE. Бот адаптируется к изменениям рынка и автоматически управляет позициями, стоп-ордерами и ребалансировкой портфеля.

