# Исправление проблемы с режимом реальной торговли

## Проблема
Режим реальной торговли не работал из-за отсутствия API endpoints для переключения режимов и системы сохранения настроек.

## Решение

### 1. Добавлена система управления настройками

#### Новые файлы:
- `src/main/java/ru/perminov/model/TradingSettings.java` - Модель для хранения настроек
- `src/main/java/ru/perminov/repository/TradingSettingsRepository.java` - Репозиторий для работы с настройками
- `init_trading_settings.sql` - SQL скрипт для инициализации настроек

#### Обновленные файлы:
- `src/main/java/ru/perminov/service/TradingModeService.java` - Добавлена работа с БД
- `src/main/java/ru/perminov/controller/TradingModeController.java` - Добавлены API endpoints
- `src/main/resources/static/js/app.js` - Обновлена логика переключения режимов
- `src/main/resources/static/index.html` - Добавлены элементы управления

### 2. Новые API endpoints

#### GET `/api/trading-mode/status`
Получение текущего статуса режима торговли

#### POST `/api/trading-mode/switch`
Переключение режима торговли с проверкой безопасности

#### POST `/api/trading-mode/switch-confirmed`
Принудительное переключение режима (для продакшена)

#### POST `/api/trading-mode/reset`
Сброс настроек к значениям по умолчанию

### 3. Улучшения безопасности

- Двойное подтверждение при переключении в режим реальной торговли
- Проверка безопасности переключения режимов
- Сохранение настроек в базе данных
- Логирование всех операций переключения

### 4. Улучшения пользовательского интерфейса

- Отображение информации о текущем режиме
- Цветовая индикация режимов (желтый для песочницы, красный для продакшена)
- Уведомления о переключении режимов
- Кнопка сброса настроек

## Установка

### 1. Выполните SQL скрипт
```bash
psql -h localhost -p 5433 -U postgres -d tbot_db -f init_trading_settings.sql
```

### 2. Перезапустите приложение
```bash
mvn spring-boot:run
```

### 3. Проверьте работу
1. Откройте веб-интерфейс: http://localhost:8081
2. Перейдите в раздел "Настройки"
3. Попробуйте переключить режим торговли

## Использование

### Переключение в режим реальной торговли:
1. Выберите "Реальная торговля" в настройках
2. Подтвердите предупреждение о рисках
3. Подтвердите еще раз для активации
4. Настройки сохранятся в базе данных

### Переключение в режим песочницы:
1. Выберите "Песочница" в настройках
2. Нажмите "Переключить режим"
3. Настройки сохранятся автоматически

### Сброс настроек:
1. Нажмите кнопку "Сбросить" в настройках
2. Подтвердите сброс
3. Настройки вернутся к значениям по умолчанию

## Безопасность

- Все переключения в режим реальной торговли требуют двойного подтверждения
- Настройки сохраняются в базе данных и не теряются при перезапуске
- Все операции логируются для аудита
- Режим по умолчанию - песочница

## Мониторинг

Для мониторинга изменений режима торговли используйте логи приложения:
```bash
tail -f logs/application.log | grep "trading mode"
```

## Устранение неполадок

### Проблема: Настройки не сохраняются
**Решение:** Проверьте подключение к базе данных и выполните SQL скрипт инициализации

### Проблема: Режим не переключается
**Решение:** Проверьте логи приложения на наличие ошибок и убедитесь, что API endpoints доступны

### Проблема: Веб-интерфейс не обновляется
**Решение:** Очистите кэш браузера и перезагрузите страницу

