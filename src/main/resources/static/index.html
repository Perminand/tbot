<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tinkoff Auto Trading Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .main-content {
            background-color: #f8f9fa;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online {
            background-color: #28a745;
        }
        .status-offline {
            background-color: #dc3545;
        }
        .loading {
            display: none;
        }
        .table-responsive {
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-3">
                <div class="d-flex flex-column h-100">
                    <div class="text-center mb-4">
                        <h4 class="text-white">
                            <i class="fas fa-robot me-2"></i>
                            Auto Trading Bot
                        </h4>
                        <div class="text-white-50 small">
                            <span class="status-indicator status-online"></span>
                            <span id="apiStatus">Online</span>
                        </div>
                        <div class="text-white-50 small mt-2">
                            <i class="fas fa-user me-1"></i>
                            Account: <span id="accountId" class="text-white">Загрузка...</span>
                        </div>
                        <div class="text-white-50 small mt-2">
                            <i class="fas fa-shield-alt me-1"></i>
                            Режим: <span id="tradingMode" class="badge bg-warning">Песочница</span>
                        </div>
                    </div>
                    
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            Dashboard
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('instruments')">
                            <i class="fas fa-list me-2"></i>
                            Инструменты
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('portfolio')">
                            <i class="fas fa-briefcase me-2"></i>
                            Портфель
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('orders')">
                            <i class="fas fa-exchange-alt me-2"></i>
                            Ордера
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('trading-bot')">
                            <i class="fas fa-robot me-2"></i>
                            Торговый бот
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('analysis')">
                            <i class="fas fa-chart-line me-2"></i>
                            Анализ
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('settings')">
                            <i class="fas fa-cog me-2"></i>
                            Настройки
                        </a>
                        <a class="nav-link" href="risk-management.html" target="_blank">
                            <i class="fas fa-shield-alt me-2"></i>
                            Управление рисками
                        </a>
                        <a class="nav-link" href="sector-management.html" target="_blank">
                            <i class="fas fa-chart-pie me-2"></i>
                            Управление секторами
                        </a>
                        <a class="nav-link" href="api-test.html" target="_blank">
                            <i class="fas fa-vial me-2"></i>
                            Тест API
                        </a>
                    </nav>
                    
                    <div class="mt-auto">
                        <div class="text-white-50 small">
                            <i class="fas fa-info-circle me-2"></i>
                            API Status: <span id="apiStatus">Checking...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content p-4">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                                    <h5 class="card-title">Общая стоимость</h5>
                                    <h3 class="text-primary" id="totalValue">₽0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-arrow-up fa-2x text-success mb-2"></i>
                                    <h5 class="card-title">Прибыль</h5>
                                    <h3 class="text-success" id="totalProfit">₽0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-wallet fa-2x text-secondary mb-2"></i>
                                    <h5 class="card-title">Изменение за день</h5>
                                    <h3 class="text-secondary" id="dailyChange">₽0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-list fa-2x text-info mb-2"></i>
                                    <h5 class="card-title">Инструменты</h5>
                                    <h3 class="text-info" id="instrumentsCount">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                                    <h5 class="card-title">Активные ордера</h5>
                                    <h3 class="text-warning" id="activeOrders">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Распределение портфеля</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="portfolioChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Последние операции</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentOperations">
                                        <p class="text-muted">Нет данных</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-wallet me-2"></i>Динамика баланса</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="balanceChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Индикатор автообновления -->
                <div class="auto-refresh-indicator" id="autoRefreshIndicator">
                    <i class="fas fa-sync-alt me-1"></i>Обновление...
                </div>

                <!-- Быстрые действия -->
                <div class="quick-actions">
                    <button class="quick-action-btn refresh" onclick="refreshDashboard()" title="Обновить дашборд">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="quick-action-btn emergency" onclick="emergencyStop()" title="Экстренная остановка">
                        <i class="fas fa-stop"></i>
                    </button>
                    <button class="quick-action-btn settings" onclick="showSection('settings')" title="Настройки">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                
                <!-- Instruments Section -->
                <div id="instruments-section" class="section" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-list me-2"></i>Инструменты</h2>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h5 class="mb-0">Список инструментов</h5>
                                </div>
                                <div class="col-auto">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadShares()">
                                            <i class="fas fa-chart-line me-1"></i>Акции
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadBonds()">
                                            <i class="fas fa-handshake me-1"></i>Облигации
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadEtfs()">
                                            <i class="fas fa-chart-pie me-1"></i>ETF
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadCurrencies()">
                                            <i class="fas fa-dollar-sign me-1"></i>Валюты
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Фильтрация -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="instrumentSearch" 
                                               placeholder="Поиск по тикеру или названию..." 
                                               onkeyup="filterInstruments()">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="statusFilter" onchange="filterInstruments()">
                                        <option value="">Все статусы</option>
                                        <option value="SECURITY_TRADING_STATUS_NORMAL_TRADING">Доступно</option>
                                        <option value="SECURITY_TRADING_STATUS_NOT_AVAILABLE_FOR_TRADING">Недоступно</option>
                                        <option value="SECURITY_TRADING_STATUS_BREAK_IN_TRADING">Перерыв</option>
                                        <option value="SECURITY_TRADING_STATUS_CLOSING_AUCTION">Закрытие</option>
                                        <option value="SECURITY_TRADING_STATUS_OPENING_AUCTION">Открытие</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="pageSize" onchange="changePageSize()">
                                        <option value="20">20 на странице</option>
                                        <option value="50" selected>50 на странице</option>
                                        <option value="100">100 на странице</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <span class="text-muted" id="instrumentsCount">Всего: 0</span>
                                </div>
                            </div>
                            
                            <div class="loading" id="instrumentsLoading">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <div id="instrumentsList">
                                <p class="text-muted">Выберите тип инструментов для загрузки</p>
                            </div>
                            
                            <!-- Пагинация -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <nav aria-label="Навигация по страницам">
                                        <ul class="pagination justify-content-center" id="pagination">
                                            <!-- Пагинация будет добавлена динамически -->
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Portfolio Section -->
                <div id="portfolio-section" class="section" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-briefcase me-2"></i>Портфель</h2>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h5 class="mb-0">Позиции в портфеле</h5>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-primary btn-sm" onclick="loadPortfolio()">
                                        <i class="fas fa-sync-alt me-1"></i>Обновить
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="loading" id="portfolioLoading">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <div id="portfolioList">
                                <p class="text-muted">Нажмите "Обновить" для загрузки портфеля</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Orders Section -->
                <div id="orders-section" class="section" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-exchange-alt me-2"></i>Ордера</h2>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h5 class="mb-0">Активные ордера</h5>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-primary btn-sm" onclick="loadOrders()">
                                        <i class="fas fa-sync-alt me-1"></i>Обновить
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="loading" id="ordersLoading">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <div id="ordersList">
                                <p class="text-muted">Нажмите "Обновить" для загрузки ордеров</p>
                            </div>
                        </div>
                    </div>
                </div>
                

                
                <!-- Trading Bot Section -->
                <div id="trading-bot-section" class="section" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-robot me-2"></i>Торговый бот</h2>
                        </div>
                    </div>
                    
                    <!-- Bot Status -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-robot fa-2x text-primary mb-2"></i>
                                    <h5 class="card-title">Статус бота</h5>
                                    <h3 class="text-primary" id="botStatus">Активен</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-clock fa-2x text-success mb-2"></i>
                                    <h5 class="card-title">Планировщик</h5>
                                    <h3 class="text-success" id="schedulerStatus">Работает</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                                    <h5 class="card-title">Анализ рынка</h5>
                                    <h3 class="text-info" id="analysisStatus">Включен</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-balance-scale fa-2x text-warning mb-2"></i>
                                    <h5 class="card-title">Ребалансировка</h5>
                                    <h3 class="text-warning" id="rebalancingStatus">Включена</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Portfolio Management -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-briefcase me-2"></i>Анализ портфеля</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="portfolioAccountId" class="form-label">ID аккаунта</label>
                                        <input type="text" class="form-control" id="portfolioAccountId" placeholder="Введите ID аккаунта">
                                    </div>
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <div class="text-muted">Стоимость</div>
                                                    <div id="riskPv" class="h5">—</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <div class="text-muted">Дневной PnL</div>
                                                    <div id="riskPnl" class="h5">—</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <div class="text-muted">Просадка</div>
                                                    <div id="riskDd" class="h5">—</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <div class="text-muted">Плечо</div>
                                                    <div id="riskLev" class="h5">—</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" onclick="analyzePortfolio()">
                                        <i class="fas fa-chart-pie me-1"></i>Анализировать портфель
                                    </button>
                                    <button class="btn btn-outline-secondary ms-2" onclick="loadRiskMetrics()">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Обновить риск‑метрики
                                    </button>
                                    <div id="portfolioAnalysisResult" class="mt-3">
                                        <p class="text-muted">Нажмите кнопку для анализа портфеля</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-balance-scale me-2"></i>Ребалансировка</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="rebalancingAccountId" class="form-label">ID аккаунта</label>
                                        <input type="text" class="form-control" id="rebalancingAccountId" placeholder="Введите ID аккаунта">
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-primary" onclick="checkRebalancing()">
                                            <i class="fas fa-search me-1"></i>Проверить
                                        </button>
                                        <button class="btn btn-success" onclick="executeRebalancing()">
                                            <i class="fas fa-sync-alt me-1"></i>Выполнить
                                        </button>
                                    </div>
                                    <div id="rebalancingResult" class="mt-3">
                                        <p class="text-muted">Проверьте необходимость ребалансировки</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trading Opportunities -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="row align-items-center">
                                        <div class="col">
                                            <h5 class="mb-0"><i class="fas fa-search me-2"></i>Лучшие торговые возможности</h5>
                                        </div>
                                        <div class="col-auto">
                                            <button class="btn btn-primary btn-sm" onclick="loadTradingOpportunities()">
                                                <i class="fas fa-sync-alt me-1"></i>Обновить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="tradingOpportunitiesResult">
                                        <p class="text-muted">Нажмите "Обновить" для поиска лучших торговых возможностей</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Automatic Trading -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Автоматическая торговля</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <p class="text-muted">
                                                <strong>Автоматическая торговля</strong> - единственный способ торговли в системе. 
                                                Бот анализирует рынок, выбирает лучшие инструменты на основе технического анализа 
                                                и автоматически выполняет торговые операции без вмешательства пользователя.
                                            </p>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-success w-100" onclick="executeAutomaticTrading()">
                                                <i class="fas fa-play me-1"></i>Запустить автоматическую торговлю
                                            </button>
                                        </div>
                                    </div>
                                    <div id="automaticTradingResult" class="mt-3">
                                        <p class="text-muted">Нажмите кнопку для запуска автоматической торговли</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manual Trading Strategy -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chess me-2"></i>Ручная торговая стратегия</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="strategyAccountId" class="form-label">ID аккаунта</label>
                                                <input type="text" class="form-control" id="strategyAccountId" placeholder="Введите ID аккаунта">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="strategyFigi" class="form-label">FIGI инструмента</label>
                                                <input type="text" class="form-control" id="strategyFigi" placeholder="BBG000B9XRY4">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">&nbsp;</label>
                                                <button class="btn btn-primary w-100" onclick="executeTradingStrategy()">
                                                    <i class="fas fa-play me-1"></i>Запустить стратегию
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="strategyResult" class="mt-3">
                                        <p class="text-muted">Введите параметры и запустите стратегию</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot Log -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="row align-items-center">
                                        <div class="col">
                                            <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Лог действий бота</h5>
                                        </div>
                                        <div class="col-auto">
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-outline-primary btn-sm" onclick="loadBotLog()">
                                                    <i class="fas fa-sync-alt me-1"></i>Обновить
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="clearBotLog()">
                                                    <i class="fas fa-trash me-1"></i>Очистить
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Log Statistics -->
                                    <div id="logStatistics" class="mb-3">
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="text-center">
                                                    <h6 class="text-muted">Всего записей</h6>
                                                    <span class="badge bg-primary" id="totalEntries">0</span>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-center">
                                                    <h6 class="text-muted">Информация</h6>
                                                    <span class="badge bg-info" id="infoCount">0</span>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-center">
                                                    <h6 class="text-muted">Предупреждения</h6>
                                                    <span class="badge bg-warning" id="warningCount">0</span>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-center">
                                                    <h6 class="text-muted">Ошибки</h6>
                                                    <span class="badge bg-danger" id="errorCount">0</span>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-center">
                                                    <h6 class="text-muted">Успех</h6>
                                                    <span class="badge bg-success" id="successCount">0</span>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-center">
                                                    <h6 class="text-muted">Торговля</h6>
                                                    <span class="badge bg-secondary" id="tradeCount">0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Log Filters -->
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <select class="form-select form-select-sm" id="logLevelFilter">
                                                <option value="">Все уровни</option>
                                                <option value="INFO">Информация</option>
                                                <option value="WARNING">Предупреждения</option>
                                                <option value="ERROR">Ошибки</option>
                                                <option value="SUCCESS">Успех</option>
                                                <option value="TRADE">Торговля</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select form-select-sm" id="logCategoryFilter">
                                                <option value="">Все категории</option>
                                                <option value="MARKET_ANALYSIS">Анализ рынка</option>
                                                <option value="PORTFOLIO_MANAGEMENT">Управление портфелем</option>
                                                <option value="TRADING_STRATEGY">Торговая стратегия</option>
                                                <option value="REBALANCING">Ребалансировка</option>
                                                <option value="TECHNICAL_INDICATORS">Технические индикаторы</option>
                                                <option value="AUTOMATIC_TRADING">Автоматическая торговля</option>
                                                <option value="RISK_MANAGEMENT">Управление рисками</option>
                                                <option value="SYSTEM_STATUS">Статус системы</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select form-select-sm" id="logLimitFilter">
                                                <option value="20">20 записей</option>
                                                <option value="50" selected>50 записей</option>
                                                <option value="100">100 записей</option>
                                                <option value="200">200 записей</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-primary btn-sm w-100" onclick="applyLogFilters()">
                                                <i class="fas fa-filter me-1"></i>Применить фильтры
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Log Entries -->
                                    <div id="botLogResult" class="mt-3">
                                        <p class="text-muted">Нажмите "Обновить" для загрузки лога</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Section -->
                <div id="analysis-section" class="section" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-chart-line me-2"></i>Анализ рынка</h2>
                        </div>
                    </div>
                    
                    <!-- Market Analysis -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Анализ тренда</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="trendAnalysisFigi" class="form-label">FIGI инструмента</label>
                                        <input type="text" class="form-control" id="trendAnalysisFigi" placeholder="BBG000B9XRY4">
                                    </div>
                                    <button class="btn btn-primary" onclick="analyzeTrend()">
                                        <i class="fas fa-search me-1"></i>Анализировать тренд
                                    </button>
                                    <div id="trendAnalysisResult" class="mt-3">
                                        <p class="text-muted">Введите FIGI и нажмите кнопку для анализа</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Технические индикаторы</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="indicatorsFigi" class="form-label">FIGI инструмента</label>
                                        <input type="text" class="form-control" id="indicatorsFigi" placeholder="BBG000B9XRY4">
                                    </div>
                                    <button class="btn btn-primary" onclick="getTechnicalIndicators()">
                                        <i class="fas fa-chart-bar me-1"></i>Получить индикаторы
                                    </button>
                                    <div id="indicatorsResult" class="mt-3">
                                        <p class="text-muted">Введите FIGI для получения технических индикаторов</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Technical Analysis Chart -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Технический анализ</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="chartFigi" class="form-label">FIGI инструмента</label>
                                            <input type="text" class="form-control" id="chartFigi" placeholder="BBG000B9XRY4">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="chartPeriod" class="form-label">Период</label>
                                            <select class="form-select" id="chartPeriod">
                                                <option value="1">1 день</option>
                                                <option value="7">7 дней</option>
                                                <option value="30" selected>30 дней</option>
                                                <option value="90">90 дней</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">&nbsp;</label>
                                            <button class="btn btn-primary w-100" onclick="loadTechnicalChart()">
                                                <i class="fas fa-chart-line me-1"></i>Загрузить график
                                            </button>
                                        </div>
                                    </div>
                                    <div id="technicalChartContainer">
                                        <canvas id="technicalChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div id="settings-section" class="section" style="display: none;">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-cog me-2"></i>Настройки</h2>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Конфигурация API</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Аварийная остановка</h6>
                                    <div class="btn-group">
                                        <button class="btn btn-danger btn-sm" onclick="panicOn()"><i class="fas fa-stop"></i> PANIC-STOP</button>
                                        <button class="btn btn-success btn-sm" onclick="panicOff()"><i class="fas fa-play"></i> Снять стоп</button>
                                    </div>
                                    <button class="btn btn-outline-danger btn-sm ms-2" onclick="cancelAllOrders()"><i class="fas fa-ban"></i> Отменить все ордера</button>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-tachometer-alt me-2"></i>Лимит ордеров</h6>
                                    <div class="input-group input-group-sm" style="max-width:260px;">
                                        <span class="input-group-text">в мин.</span>
                                        <input type="number" class="form-control" id="maxOrdersPerMinute" value="30" min="1">
                                        <button class="btn btn-primary" onclick="updateOrderLimit()">Применить</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">API Status</label>
                                        <div>
                                            <span class="badge bg-success" id="apiStatusBadge">Online</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Режим работы</label>
                                        <div>
                                            <span class="badge bg-warning" id="tradingModeStatus">Песочница</span>
                                        </div>
                                        <div class="mt-2">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="tradingMode" id="sandboxMode" value="sandbox" checked>
                                                <label class="form-check-label" for="sandboxMode">Песочница</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="tradingMode" id="productionMode" value="production">
                                                <label class="form-check-label" for="productionMode">Реальная торговля</label>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-primary mt-2" onclick="switchTradingMode()">
                                            <i class="fas fa-sync-alt me-1"></i>Переключить режим
                                        </button>
                                        <button class="btn btn-sm btn-secondary mt-2 ms-2" onclick="resetTradingMode()">
                                            <i class="fas fa-undo me-1"></i>Сбросить
                                        </button>
                                        <div class="mt-2">
                                            <small class="text-muted" id="tradingModeInfo">
                                                Режим песочницы активен. Все операции выполняются в тестовой среде.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">База данных</label>
                                        <div>
                                            <span class="badge bg-info" id="dbStatus">Connected</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Версия приложения</label>
                                        <div>
                                            <span class="text-muted">1.0.0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Rules -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Стоп-правила (по FIGI)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label">FIGI</label>
                                    <input type="text" id="riskFigi" class="form-control" placeholder="BBG...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Stop-Loss %</label>
                                    <input type="number" step="0.01" min="0.1" id="riskSl" class="form-control" placeholder="5">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Take-Profit %</label>
                                    <input type="number" step="0.01" min="0.1" id="riskTp" class="form-control" placeholder="10">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary" onclick="saveRiskRule()"><i class="fas fa-save me-1"></i>Сохранить</button>
                                    <button class="btn btn-outline-secondary ms-2" onclick="loadRiskRule()"><i class="fas fa-search me-1"></i>Проверить</button>
                                </div>
                            </div>
                            <div id="riskRuleResult" class="mt-2 text-muted"></div>
                        </div>
                    </div>

                    <!-- Hard Stops (Production) -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-lock me-2"></i>Жёсткие стоп‑ордера (продакшн)</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-info-circle me-1"></i>
                                При включении бот будет ставить реальные OCO‑ордера (take‑profit + stop‑loss) у брокера в продакшене
                                сразу после входа. Редактирование уровней выполняется через переустановку OCO (новые уровни → отмена старых).
                                В песочнице эта функция недоступна.
                            </div>
                            <div class="row g-3 align-items-center">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="hardStopsEnabled">
                                        <label class="form-check-label" for="hardStopsEnabled">
                                            Включить жёсткие стопы (продакшн‑режим)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="hardStopsTrailingEnabled">
                                        <label class="form-check-label" for="hardStopsTrailingEnabled">
                                            Включить трэйлинг: при улучшении цены переустанавливать стоп
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="small text-muted mt-2">
                                - Стоп‑лосс и тейк‑профит берутся из правил по FIGI или из дефолтов в настройках.<br>
                                - Для «редактирования» уровней бот создаёт новую OCO‑связку и отменяет старую (без окна без защиты).<br>
                                - Учитываются биржевые ограничения: шаг цены, статус торгов, лимиты API.
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="saveHardStopsSettings()">
                                    <i class="fas fa-save me-1"></i>Сохранить настройки
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="loadHardStopsSettings()">
                                    <i class="fas fa-sync-alt me-1"></i>Обновить
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Liquidity Block Settings -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-water me-2"></i>Ликвидность: блокировки и логи</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="liquidityLogEnabled" checked>
                                        <label class="form-check-label" for="liquidityLogEnabled">
                                            Показывать блокировки по ликвидности в логах
                                        </label>
                                    </div>
                                    <small class="text-muted">Отключите, чтобы не захламлять BotLog предупреждениями о ликвидности.</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Период блокировки</label>
                                    <select class="form-select form-select-sm" id="liquidityBlockDuration" style="max-width:220px;">
                                        <option value="day" selected>День</option>
                                        <option value="week">Неделя</option>
                                        <option value="month">Месяц</option>
                                    </select>
                                    <small class="text-muted">По умолчанию — День.</small>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="saveLiquiditySettings()">
                                    <i class="fas fa-save me-1"></i>Сохранить настройки
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="loadLiquiditySettings()">
                                    <i class="fas fa-sync-alt me-1"></i>Обновить
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sandbox Account Management -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-piggy-bank me-2"></i>Управление песочницей</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Пополнение баланса</h6>
                                    <form id="topUpForm">
                                        <div class="mb-3">
                                            <label for="topUpAccountId" class="form-label">ID аккаунта</label>
                                            <input type="text" class="form-control" id="topUpAccountId" placeholder="66881038-1e18-4b77-989f-35d05558cd07" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label for="topUpCurrency" class="form-label">Валюта</label>
                                            <select class="form-select" id="topUpCurrency" required>
                                                <option value="rub">Рубли (RUB)</option>
                                                <option value="usd">Доллары (USD)</option>
                                                <option value="eur">Евро (EUR)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="topUpAmount" class="form-label">Сумма</label>
                                            <input type="number" class="form-control" id="topUpAmount" step="0.01" min="0.01" placeholder="100000.00" required>
                                        </div>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-plus me-1"></i>Пополнить баланс
                                        </button>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <h6>Управление аккаунтом</h6>
                                    <div class="mb-3">
                                        <button class="btn btn-primary btn-sm" onclick="createSandboxAccount()">
                                            <i class="fas fa-plus me-1"></i>Создать аккаунт
                                        </button>
                                        <button class="btn btn-danger btn-sm ms-2" onclick="closeSandboxAccount()">
                                            <i class="fas fa-trash me-1"></i>Закрыть аккаунт
                                        </button>
                                    </div>
                                    <div class="alert alert-info">
                                        <small>
                                            <i class="fas fa-info-circle me-1"></i>
                                            В песочнице можно пополнять баланс для тестирования торговли. 
                                            Создайте аккаунт и пополните его для начала торговли.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Margin Trading Settings -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-percentage me-2"></i>Маржинальная торговля</h5>
                        </div>
                        <div class="card-body">
                            <div id="marginStatusNote" class="alert alert-info d-none"></div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="marginEnabled">
                                        <label class="form-check-label" for="marginEnabled">Включить маржинальную торговлю</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="marginAllowShort">
                                        <label class="form-check-label" for="marginAllowShort">Разрешить короткие позиции (шорт)</label>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3 mt-1">
                                <div class="col-md-4">
                                    <label for="marginMaxUtilizationPct" class="form-label">Доля портфеля на маржинальные покупки (0..1)</label>
                                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="marginMaxUtilizationPct" placeholder="0.30">
                                </div>
                                <div class="col-md-4">
                                    <label for="marginMaxShortPct" class="form-label">Доля портфеля на шорт (0..1)</label>
                                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="marginMaxShortPct" placeholder="0.10">
                                </div>
                                <div class="col-md-4">
                                    <label for="marginMaxLeverage" class="form-label">Максимальное кредитное плечо (информационно)</label>
                                    <input type="number" step="0.01" min="1" class="form-control" id="marginMaxLeverage" placeholder="1.30">
                                </div>
                            </div>

                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="saveMarginSettings()">
                                    <i class="fas fa-save me-1"></i>Сохранить настройки
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="loadMarginSettings()">
                                    <i class="fas fa-sync-alt me-1"></i>Обновить
                                </button>
                                <button class="btn btn-outline-info ms-2" onclick="showMarginAttributes()">
                                    <i class="fas fa-eye me-1"></i>Показать лимиты маржи
                                </button>
                                <button class="btn btn-outline-warning ms-2" onclick="showBuyingPower()">
                                    <i class="fas fa-wallet me-1"></i>Покупательная способность
                                </button>
                            </div>
                            <div id="marginAttrs" class="mt-3 d-none"></div>
                            <div id="marginBp" class="mt-2 d-none"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/app.js"></script>
</body>
</html> 